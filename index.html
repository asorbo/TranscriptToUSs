<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>From Elicitation Interviews to User Stories</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh; /* use full viewport height */
            }

        .container {
            display: grid;
            grid-template-rows: auto auto 1fr; /* title + spans + form/textarea grows */
            width: 80%;
            margin: 0 auto;
            flex: 1;
            overflow: hidden;
        }

        h1 {
            grid-row: 1;
            margin-top: 5vh;
        }

        textarea, button, progress {
            border-radius: 0; /* square corners */
        }

        .spanContainer {
            grid-row: 2;
        }

        .spanContainer span {
            margin-bottom: 1em;
            display: block;
        }

        #uploadForm {
            grid-row: 3;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        textarea {
            width: 100% !important;
            min-height: 5vh;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 0;
            box-sizing: border-box;
            color: #333;
            text-align: left;
            flex: 1 1 auto;
            resize: none;
        }

        textarea::placeholder {
            line-height: 5vh;
            vertical-align: text-bottom;
            text-align: center;
            font-size: 1.1rem;
            color: #888;
        }



        /* Button styling */
        button {
            display: block;
            margin: 1vh auto 20px auto;
            padding: 10px 20px;
            font-size: 1.1rem;
            background-color: #1648d2;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #001ba0;
        }

        #stopButton {
            background-color: red; 
            color: white;
            display: none;
        }

        #stopButton:disabled {
            background-color: #ff9999;
            color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        #downloadButton {
            background-color: #28a745;
            color: white;
            display: none;
        }

        #downloadButton:hover {
            background-color: #218838;
        }
        
        footer {
            width: 100%;
            background: #f0f0f0;
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            color: #555;
        }

        footer a {
            color: #0066cc;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        footer span {
            display: block;
            margin: 1em 0;
        }

        #progressContainer{
            position: relative; 
            width: 100%; 
            height: 20px; 
            background: white; 
            border-radius: 0;
        }
        #progressFill{
            background: #f0f0f0; 
            width: 0%; 
            height: 100%;
        }
        
        #progressText{
            position: absolute; 
            top: 0; left: 50%; 
            transform: translateX(-50%); 
            color: #555; 
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>From Elicitation Interviews to User Stories: A Prompt Chaining LLM Approach for Automated Candidate Requirements Extraction</h1>
        <div class="spanContainer">
            <span>
                This prototype formulates candidate requirements in the form of User Stories. This is done based on a transcript of an elicitation session. Through a series of prompts, the system progressively extracts requirement-relevant content. 
                Finally, User Stories are formulated while preserving trace-links to the transcript to promote interpretability.<br>
                The process involves several steps and may last several minutes depending on the transcript length and its complexity.
            </span>
            <span>
                Note: The processing is done using google gemini API. Refer to their conditions to know about their data handling practices.
                Any input provided to this tool will be permanently deleted when the instance is terminated.
                This includes the transcript uploaded to the prototype, as well as all intermediate and final outputs.
                The final outputs are retained only in the ZIP archive downloaded to your device at the end of the process.
            </span>
        </div>
        <form id="uploadForm" onsubmit="return false;">
            <textarea id="transcript" placeholder="Paste your elicitation transcript here..."></textarea>
            <div id="progressContainer">
                <div id="progressFill"></div>
                <span id="progressText"></span>
            </div>
            <button id="submitButton" type="button">Launch the extraction</button>
            <button id="stopButton">Stop Execution</button>
            <button id="downloadButton">Download Outputs Again...</button>
        </form>
    </div>

    <footer>
        <span>
            Tool developed as part of the master thesis: 
            “From Elicitation Interviews to User Stories: A Prompt Chaining LLM Approach for Automated Candidate Requirements Extraction”
            <br>
            written by <a href="https://www.linkedin.com/in/agostino-sorbo-55135716a/">Agostino Sorbo</a> 
            with the supervision of <a href="https://www.uu.nl/staff/FDalpiaz">Fabiano Dalpiaz</a> 
            and <a href="https://www.uu.nl/staff/TSpijkman">Tjerk Spijkman</a>.
        <br>
            2025 - <a href="https://www.uu.nl/en">Utrecht University</a>, The Netherlands.
        </span>
        <span>
            Paper and codebase available on <a href="https://github.com/asorbo/TranscriptToUSs" target="_blank">GitHub</a>.
        </span>
    </footer>

    <script defer>
        document.getElementById("submitButton").addEventListener("click", handleSubmit);

        function handleSubmit(e) {
            e.preventDefault();
            const text = document.getElementById("transcript").value.trim();

            if (!text) {
                alert("Please enter a transcript before submitting.");
                return; 
            }

            // Disable submit to prevent double submission
            document.getElementById("submitButton").disabled = true;

            fetch("/process_text", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ transcript: text })
            }).catch(err => console.error(err));

            // Switch buttons
            document.getElementById("submitButton").style.display = "none";
            document.getElementById("stopButton").style.display = "inline-block";
            document.getElementById("stopButton").addEventListener("click", stopExecution);

            follow_updates();
        }

        function stopExecution(e) {
            e.preventDefault();
            if (confirm("Are you sure you want to stop execution?")) {
                fetch("/stop_execution", { method: "POST" })
                    .then(resp => resp.json())
                    .then(data => alert(data.message))
                    .catch(err => console.error(err));
                document.getElementById("stopButton").removeEventListener("click", stopExecution);
                document.getElementById("stopButton").disabled = true;
                document.getElementById("stopButton").innerText = "Execution stop requested";
            }
        }

        function follow_updates() {
            const textarea = document.getElementById("transcript");
            textarea.readOnly = true;
            textarea.value = "Transcript uploaded. Connecting to log stream...\n";
            const eventSource = new EventSource("/stream_logs");
            eventSource.addEventListener("done", () => {
                eventSource.close();
            });
            eventSource.onmessage = function(event) {
                updateProgress(event.data);
                textarea.value += event.data + "\n";
                textarea.scrollTop = textarea.scrollHeight; // auto-scroll
            };
        }

        function downloadOutputs() {
            const textarea = document.getElementById("transcript");
            document.getElementById("stopButton").style.display = "none";
            document.getElementById("downloadButton").style.display = "inline-block";
            textarea.value = "\nExecution completed. The download of the outputs should start automatically. If not, please click the button below.\n";
            document.getElementById("downloadButton").addEventListener("click", () => {
                window.location.href = "/download_outputs";
            });
            textarea.style.fontSize = "2rem";
            fetch("/download_outputs")
                .then(resp => {
                    if (resp.ok) {
                        return resp.blob();
                    } else {
                        throw new Error("Failed to download outputs");
                    }
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "outputs.zip";  // or whatever filename you want
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch(err => console.error(err));
        }

        function updateProgress(message) {
            let percent = 0;
            if (message.includes("Pipeline status")) {
                if (message == "Pipeline status: Execution completed") {
                    setProgress(100, "Execution completed.");
                    downloadOutputs();
                    return
                }
                let half_message = message.split("/");
                const numerator = parseInt(half_message[0].split(" ").pop());
                const denominator = parseInt(half_message[1].split(" ")[0]);
                percent = Math.floor((numerator / denominator) * 100);
                let bar_message = `Part ${numerator} of ${denominator}: ${message.split(":").pop().trim()}`;
                setProgress(percent, bar_message);
            }
        }

        function setProgress(percent, new_text) {
            const fill = document.getElementById("progressFill");
            const text = document.getElementById("progressText");
            fill.style.width = percent + "%";
            if (new_text != undefined){
                text.textContent = new_text;
            }
        }
    </script>
</body>
</html>
